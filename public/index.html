<!DOCTYPE html>
<html lang="en">
<head>
  <title>User Page</title>
  <script type="text/javascript" src="/public/scripts/jquery-1.12.0.min.js"></script>
  <script type="text/javascript" src="/public/scripts/js-cookie.js"></script>
  <link rel="stylesheet" href="/public/css/bootstrap.min.css">
  <script type="text/javascript">
    jQuery(document).ready(function(){
      function userClickListener(){
        $('.user-item').unbind();
        $('.user-item').click(function(){
            ws.send(JSON.stringify({
              'function': 'send',
              'target': $(this).attr('id'),
              'sender': Cookies.get('username'),
            }));
        });
      }

      var ws = new WebSocket("ws://localhost:8080/invite");

      ws.onmessage = function(event){
          var request = $.parseJSON(event.data).request;
          console.log(request);
      }
      /*
      var ws = new WebSocket("ws://localhost:8080/ws");

      ws.onopen = function(){
        alert("connected!");
      };

      ws.onmessage = function(evt){
        var data = $.parseJSON(evt.data);
        switch(data.function){
          case "add_user":
              $('#result_area').html(data.message);
              break;
          case "show_users":
              $('#user_area').html("");
              data.users.forEach(function(user){
                  $('#user_area').append(user + "<br>");
              });

        }
        $('#result_area').html(data.message);
      };

      $('#enter_name').click(function(event){
        event.preventDefault();
        var input = $('#username').val();
        ws.send(JSON.stringify({'function': 'add_user', 'username': input}));
      });

      $('#show_users').click(function(event){
        event.preventDefault();
        ws.send(JSON.stringify({'function': 'show_users'}));
      });*/

      $('#create_game').click(function(event){
          event.preventDefault();
          $.ajax({
            method: "PUT",
            url: "/game",
          }).done(function(data){
              var gameID = $.parseJSON(data).gameID;
              window.location.replace('./game/'+gameID);
          });
      });

      $('#enter_name').click(function(event){
        event.preventDefault();
        var uname = $('#username').val();
        $.ajax({
           method: "PUT",
           url: "/users",
           data: { username: uname },
           statusCode: {
             201: function(){
               $('#result_area').html("User successfully created.");
             },
             409: function(){
               $('#result_area').html("User already exists.  Please try again.");
             }
           }
        });
      });

      $('#show_users').click(function(event){
          event.preventDefault();
          $.ajax({
            method: "GET",
            url: "/users"
          }).done(function(data){
            $('#user_area').html("<ul>");
              var users = $.parseJSON(data).users;
              users.forEach(function(item){
                  $('#user_area').append("<li class=\"user-item\" id=\"" + item.username + "\">" + item.username + " : " + item.rating + "</li><br>");
              });
              $('#user_area').append("</ul>");
              userClickListener();
          });
      });
    });
  </script>
</head>
<body>
  <form>
      <input type="text" id="username">
      <button class="btn btn-default" id="enter_name">Submit</button>
  </form>
      <button class="btn btn-large" id="show_users">Show Users</button>

      <center><button class="btn btn-default" id="create_game">Create Game</button></center>

  <div class="alert" id="result_area">
  </div>

  <div class="well" id="user_area">
  </div>

</body>
</html>
